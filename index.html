import React, { useState, useEffect } from "react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Folder, File, Download } from "lucide-react";

const GITHUB_REPO = "Powerpoints2727/King-s-Resources";
const API_URL = `https://api.github.com/repos/${GITHUB_REPO}/contents/`;

const RepoViewer = () => {
  const [files, setFiles] = useState([]);
  const [expandedFolders, setExpandedFolders] = useState({});
  const [selectedFile, setSelectedFile] = useState(null);
  const [searchQuery, setSearchQuery] = useState("");

  useEffect(() => {
    fetchFiles("");
  }, []);

  const fetchFiles = async (path) => {
    try {
      const response = await fetch(API_URL + path);
      const data = await response.json();
      setFiles((prev) => ({ ...prev, [path]: data }));
    } catch (error) {
      console.error("Error fetching files:", error);
    }
  };

  const toggleFolder = (path) => {
    setExpandedFolders((prev) => ({
      ...prev,
      [path]: !prev[path],
    }));
    if (!files[path]) fetchFiles(path);
  };

  const handleFileClick = (file) => {
    setSelectedFile(file);
  };

  const filteredFiles = (path) => {
    if (!files[path]) return [];
    return files[path].filter((file) => file.name.toLowerCase().includes(searchQuery.toLowerCase()));
  };

  return (
    <div className="flex h-screen">
      <div className="w-1/3 border-r p-4 overflow-auto">
        <Input placeholder="Search files..." onChange={(e) => setSearchQuery(e.target.value)} />
        <div className="mt-4">
          {filteredFiles("").map((file) => (
            <div key={file.path} className="flex items-center gap-2 cursor-pointer p-2 hover:bg-gray-200" onClick={() => (file.type === "dir" ? toggleFolder(file.path) : handleFileClick(file))}>
              {file.type === "dir" ? <Folder className="text-blue-500" /> : <File className="text-gray-500" />}
              <span>{file.name}</span>
              {file.type === "file" && (
                <a href={file.download_url} target="_blank" rel="noopener noreferrer" download>
                  <Button size="icon" variant="ghost">
                    <Download className="w-4 h-4" />
                  </Button>
                </a>
              )}
            </div>
          ))}
        </div>
      </div>
      <div className="w-2/3 p-4">
        {selectedFile ? (
          <Card>
            <CardContent className="p-4">
              <h2 className="text-lg font-semibold">{selectedFile.name}</h2>
              <iframe src={selectedFile.download_url} className="w-full h-[500px]" title="File Preview"></iframe>
            </CardContent>
          </Card>
        ) : (
          <p>Select a file to preview</p>
        )}
      </div>
    </div>
  );
};

export default RepoViewer;

